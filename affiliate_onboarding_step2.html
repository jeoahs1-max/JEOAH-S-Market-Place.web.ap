<!                    submitButton.disabled = false;
  <!-- 
    affiliate_onboarding_step2.html - Onboarding Affilié, Étape 2 : Réseaux Sociaux (V3)
    
    Cette version inclut la liste complète des réseaux sociaux demandée par l'utilisateur:
    TikTok, YouTube, Instagram (requis), Facebook, Quora, Reddit, Twitch, Twitter et Telegram (optionnels).
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affilié - Étape 2 : Réseaux Sociaux</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId;
        // Initialisation de la structure de données pour tous les réseaux
        let socialLinks = {
            tiktok: "", youtube: "", instagram: "", facebook: "", quora: "", reddit: "", twitch: "", twitter: "", telegram: "", snapchat: ""
        };

        const SOCIAL_PLATFORMS = [
            // REQUIS
            { id: 'tiktok', name: 'TikTok', icon: 'fab fa-tiktok', color: 'text-black', placeholder: 'Lien de votre profil TikTok', required: true },
            { id: 'youtube', name: 'YouTube', icon: 'fab fa-youtube', color: 'text-red-600', placeholder: 'Lien de votre chaîne YouTube', required: true },
            { id: 'instagram', name: 'Instagram', icon: 'fab fa-instagram', color: 'text-pink-500', placeholder: 'Lien de votre profil Instagram', required: true },
            
            // OPTIONNELS
            { id: 'twitter', name: 'X / Twitter', icon: 'fab fa-twitter', color: 'text-gray-700', placeholder: 'Lien de votre profil X (Twitter)', required: false },
            { id: 'twitch', name: 'Twitch', icon: 'fab fa-twitch', color: 'text-purple-600', placeholder: 'Lien de votre chaîne Twitch', required: false },
            { id: 'reddit', name: 'Reddit', icon: 'fab fa-reddit', color: 'text-orange-500', placeholder: 'Lien de votre profil Reddit', required: false },
            { id: 'quora', name: 'Quora', icon: 'fab fa-quora', color: 'text-red-700', placeholder: 'Lien de votre profil Quora', required: false }, 
            { id: 'telegram', name: 'Telegram', icon: 'fab fa-telegram', color: 'text-blue-500', placeholder: 'Lien de votre canal/profil Telegram', required: false }, // Ajouté
            { id: 'snapchat', name: 'Snapchat', icon: 'fab fa-snapchat', color: 'text-yellow-400', placeholder: 'Lien de votre profil Snapchat', required: false }, // Ajouté
            { id: 'facebook', name: 'Facebook', icon: 'fab fa-facebook', color: 'text-blue-600', placeholder: 'Lien de votre page/profil Facebook', required: false }, 
        ];
        
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            // Le rendu sera appelé après le chargement des données
        });

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('loading-indicator').classList.add('hidden');
                renderSocialLinks();
                document.getElementById('onboarding-content').classList.remove('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erreur d'authentification:", error);
            }

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    return;
                }
                userId = user.uid;
                await loadExistingLinks();
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('onboarding-content').classList.remove('hidden');
            });
        }
        
        /**
         * Charge les liens existants depuis Firestore.
         */
        async function loadExistingLinks() {
            if (!userId || !db) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/affiliate_data/socials`);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data()) {
                    // Fusionner les données existantes avec le modèle actuel
                    socialLinks = { ...socialLinks, ...docSnap.data() };
                }
                renderSocialLinks(); // Mettre à jour l'UI avec les données chargées
            } catch (e) {
                console.error("Erreur lors du chargement des liens sociaux:", e);
                renderSocialLinks(); // Afficher la page même en cas d'erreur
            }
        }

        /**
         * Met à jour la valeur d'un lien social lors de la saisie.
         */
        window.handleInputChange = function(platformId, value) {
            socialLinks[platformId] = value;
            // Retirer la bordure rouge si le champ est rempli
            if (value.trim()) {
                 document.getElementById(`input-${platformId}`).classList.remove('border-red-500');
            }
        }

        /**
         * Affiche la liste complète des liens sociaux dans l'interface utilisateur.
         */
        function renderSocialLinks() {
            const container = document.getElementById('social-links-container');
            container.innerHTML = '';
            
            // Séparer les requis des optionnels pour l'affichage
            const requiredPlatforms = SOCIAL_PLATFORMS.filter(p => p.required);
            const optionalPlatforms = SOCIAL_PLATFORMS.filter(p => !p.required);

            // Rendu des liens REQUIS
            requiredPlatforms.forEach(platform => {
                container.innerHTML += createSocialLinkHtml(platform, socialLinks[platform.id] || "");
            });

            // Ajout du séparateur pour les liens optionnels
            container.innerHTML += `
                <div class="pt-6 pb-2 text-lg font-bold text-gray-700 border-t border-gray-200 mt-4">
                    Autres Réseaux (Optionnels)
                </div>
            `;
            
            // Rendu des liens OPTIONNELS
            optionalPlatforms.forEach(platform => {
                container.innerHTML += createSocialLinkHtml(platform, socialLinks[platform.id] || "");
            });
        }
        
        /**
         * Génère le HTML pour une carte de lien social.
         */
        function createSocialLinkHtml(platform, currentValue) {
            const isRequired = platform.required;
            return `
                <div class="p-4 rounded-xl border border-gray-200 bg-white shadow-sm transition hover:shadow-lg">
                    <label for="input-${platform.id}" class="block text-sm font-semibold text-gray-800 flex items-center mb-1">
                        <i class="${platform.icon} ${platform.color} text-xl mr-3 w-6 text-center"></i>
                        ${platform.name} ${isRequired ? '(*)' : ''}
                    </label>
                    <input type="url" id="input-${platform.id}" 
                           value="${currentValue}" 
                           oninput="handleInputChange('${platform.id}', this.value)"
                           placeholder="${platform.placeholder}"
                           class="mt-2 block w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
            `;
        }


        /**
         * Gère la soumission du formulaire et l'enregistrement dans Firestore.
         */
        window.handleSubmit = async function(event) {
            event.preventDefault();
            
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Vérification...';
            
            let allValid = true;

            // 1. Validation : Vérifier si les champs requis (TikTok, YouTube, Instagram) sont remplis
            const linksToSave = {};
            SOCIAL_PLATFORMS.forEach(platform => {
                const value = socialLinks[platform.id] ? socialLinks[platform.id].trim() : '';
                const inputElement = document.getElementById(`input-${platform.id}`);
                
                inputElement.classList.remove('border-red-500');

                if (platform.required && !value) {
                    inputElement.classList.add('border-red-500');
                    allValid = false;
                }
                
                // Conserver le lien s'il est rempli
                if (value) {
                    linksToSave[platform.id] = value;
                }
            });

            if (!allValid) {
                showCustomModal("Champs Obligatoires Manquants", "Veuillez remplir les liens pour TikTok, YouTube et Instagram (champs en rouge) avant de continuer.");
                submitButton.disabled = false;
                submitButton.innerHTML = 'Étape Suivante <i class="fas fa-arrow-right ml-2"></i>';
                return;
            }

            console.log("Liens Sociaux à enregistrer:", linksToSave);

            if (userId && db) {
                try {
                    // Stockage des liens sociaux dans un document 'socials'
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/affiliate_data/socials`);
                    await setDoc(docRef, linksToSave, { merge: true });
                    
                    window.location.href = 'affiliate_onboarding_step3.html'; // Rediriger vers l'étape 3
                } catch (e) {
                    console.error("Erreur d'enregistrement sur Firestore:", e);
                    showCustomModal("Erreur", "Une erreur est survenue lors de l'enregistrement. Veuillez réessayer.");
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Étape Suivante <i class="fas fa-arrow-right ml-2"></i>';
                }
            } else {
                // Mode Débogage sans Firebase
                await new Promise(r => setTimeout(r, 1000));
                window.location.href = 'affiliate_onboarding_step3.html';
            }
        }

        // Fonction pour afficher une modale personnalisée (remplacement de alert())
        function showCustomModal(title, message) {
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[999]">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold text-red-600 mb-4">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('custom-alert-modal').remove()" 
                                class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .border-red-500 {
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body>

    <!-- Indicateur de Chargement -->
    <div id="loading-indicator" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
        <p class="ml-4 text-gray-600 text-lg">Chargement de votre session...</p>
    </div>

    <!-- Contenu de l'Onboarding -->
    <div id="onboarding-content" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white p-8 rounded-3xl shadow-2xl">
            
            <header class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-[#032C4F]">Configuration Affilié</h1>
                <p class="text-gray-500 mt-2">Étape 2/3: Liens de Réseaux Sociaux</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: 66%"></div>
                </div>
            </header>

            <form onsubmit="handleSubmit(event)" class="space-y-6">
                
                <p class="text-gray-700 font-medium bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                    Ajoutez les liens de vos réseaux sociaux. **TikTok, YouTube et Instagram sont obligatoires** pour la validation de votre profil. Les autres sont optionnels.
                </p>

                <!-- Conteneur des Liens Sociaux (rendus par JS) -->
                <div id="social-links-container" class="space-y-4">
                    <!-- Les liens sont insérés ici par renderSocialLinks() -->
                </div>

                <!-- Boutons de Navigation -->
                <div class="flex justify-between pt-4">
                    <a href="affiliate_onboarding_step1.html" class="py-3 px-6 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition duration-300 shadow-md flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Précédent
                    </a>
                    <button type="submit" id="submit-button" class="py-3 px-6 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg flex items-center">
                        Étape Suivante <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

