<!-- 
    auth.html - Page d'Authentification et d'Inscription JEOAH'S
    
    Mise à jour : Le champ "Type de Compte" est maintenant placé en dernier, après les mots de passe.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEOAH'S - Authentification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script type="module">
        // Import des librairies Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // IMPORTANT : Utilisation des variables globales fournies par l'environnement
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;

        // Fonction d'initialisation et d'authentification
        async function initFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize.");
                    return;
                }
                
                // Mettre le niveau de log à Debug pour le débogage de Firestore
                setLogLevel('Debug'); 

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Tentative d'authentification avec le token ou de manière anonyme
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase initialisé et utilisateur authentifié.");

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase ou de l'authentification:", error);
                displayMessage(`Erreur d'initialisation: ${error.message}`, 'error');
            }
        }
        
        // Exécuter l'initialisation au chargement de la page
        initFirebaseAndAuth();

        // --- Fonctions d'aide pour l'UI (Modal personnalisé pour remplacer alert/confirm) ---

        function displayMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'p-3 rounded-xl text-center font-semibold mb-4';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            messageBox.classList.remove('hidden');
        }

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Ajout des écouteurs pour la visibilité des mots de passe
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-toggle-register').addEventListener('click', () => togglePasswordVisibility('password-register'));
            document.getElementById('password-toggle-confirm').addEventListener('click', () => togglePasswordVisibility('password-confirm'));
            document.getElementById('password-toggle-login').addEventListener('click', () => togglePasswordVisibility('password-login'));
        });


        // --- Logique d'Authentification ---

        // Fonction pour générer le code de parrainage JSMP-
        function generateReferralCode(uid) {
            // Utilise les 6 premiers caractères de l'UID
            const shortUid = uid.substring(0, 6).toUpperCase(); 
            return `JSMP-${shortUid}`;
        }


        async function handleRegistration(event) {
            event.preventDefault();
            document.getElementById('message-box').classList.add('hidden'); // Masquer les anciens messages
            
            const fullName = document.getElementById('full-name-register').value; 
            const email = document.getElementById('email-register').value;
            const password = document.getElementById('password-register').value;
            const confirmPassword = document.getElementById('password-confirm').value;
            const role = document.getElementById('role-select').value; // Récupère le rôle
            
            
            if (password !== confirmPassword) {
                return displayMessage("Les mots de passe ne correspondent pas.", 'error');
            }
            if (fullName.trim() === '') {
                return displayMessage("Veuillez entrer votre nom complet.", 'error');
            }

            if (auth === undefined || db === undefined) {
                return displayMessage("Erreur: Firebase n'est pas initialisé.", 'error');
            }

            try {
                // 1. Création de l'utilisateur dans Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. Génération du code de parrainage unique
                const referralCode = generateReferralCode(user.uid);

                // 3. Enregistrement du rôle et du nom complet dans Firestore
                // Path: /artifacts/{appId}/users/{userId}/user_data/profile
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_data/profile`);
                const userData = {
                    uid: user.uid,
                    fullName: fullName, 
                    email: user.email,
                    role: role,
                    referralCode: referralCode, // Code unique JSMP
                    createdAt: new Date(),
                    subscriptionStatus: 'Gratuit (Essai)' // Statut initial
                };
                // Stockage des données de profil dans une collection privée de l'utilisateur
                await setDoc(userDocRef, userData); 

                displayMessage(`Inscription réussie ! Votre code de parrainage est ${referralCode}. Redirection en cours...`);
                
                // 4. Redirection vers le tableau de bord
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);

            } catch (error) {
                console.error("Erreur d'inscription:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Cet e-mail est déjà utilisé. Veuillez vous connecter.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Le format de l'e-mail est invalide.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Le mot de passe doit contenir au moins 6 caractères.";
                }
                displayMessage(`Erreur d'inscription: ${errorMessage}`, 'error');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            document.getElementById('message-box').classList.add('hidden');
            
            const email = document.getElementById('email-login').value;
            const password = document.getElementById('password-login').value;

            if (auth === undefined) {
                return displayMessage("Erreur: Firebase n'est pas initialisé.", 'error');
            }

            try {
                // 1. Connexion de l'utilisateur
                await signInWithEmailAndPassword(auth, email, password);
                
                displayMessage(`Connexion réussie ! Redirection en cours...`);
                // 2. Redirection vers le tableau de bord
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error("Erreur de connexion:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "E-mail ou mot de passe incorrect.";
                }
                displayMessage(`Erreur de connexion: ${errorMessage}`, 'error');
            }
        }

        // --- Logique d'alternance des formulaires (Connexion/Inscription) ---
        
        function switchForm(formId) {
            const registerForm = document.getElementById('register-form-container');
            const loginForm = document.getElementById('login-form-container');
            const registerTab = document.getElementById('register-tab');
            const loginTab = document.getElementById('login-tab');

            if (formId === 'register') {
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                registerTab.classList.add('border-b-4', 'border-blue-500', 'text-blue-600');
                loginTab.classList.remove('border-b-4', 'border-blue-500', 'text-blue-600');
            } else {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginTab.classList.add('border-b-4', 'border-blue-500', 'text-blue-600');
                registerTab.classList.remove('border-b-4', 'border-blue-500', 'text-blue-600');
            }
            document.getElementById('message-box').classList.add('hidden'); // Masquer les messages
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('register-tab').addEventListener('click', () => switchForm('register'));
            document.getElementById('login-tab').addEventListener('click', () => switchForm('login'));
            document.getElementById('register-form').addEventListener('submit', handleRegistration);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Afficher le formulaire d'inscription par défaut
            switchForm('register');
        });
        
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .form-card {
            max-width: 450px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        .tab-button {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="form-card bg-white rounded-2xl p-6 sm:p-8 w-full">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900">Bienvenue sur JEOAH'S</h1>
            <p class="text-gray-500 mt-1">Connectez-vous pour continuer</p>
        </div>
        
        <div id="message-box" class="hidden"></div>

        <!-- Onglets (Tabs) -->
        <div class="flex border-b border-gray-200 mb-6">
            <div id="register-tab" class="tab-button text-gray-500 hover:text-blue-600 flex-1 text-center border-b-4 border-transparent">
                S'inscrire
            </div>
            <div id="login-tab" class="tab-button text-gray-500 hover:text-blue-600 flex-1 text-center border-b-4 border-transparent">
                Se connecter
            </div>
        </div>

        <!-- Conteneur d'Inscription -->
        <div id="register-form-container">
            <form id="register-form" class="space-y-4">
                <!-- 1. Nom Complet -->
                <div>
                    <label for="full-name-register" class="block text-sm font-medium text-gray-700">Nom Complet</label>
                    <input type="text" id="full-name-register" name="full-name-register" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- 2. Adresse E-mail -->
                <div>
                    <label for="email-register" class="block text-sm font-medium text-gray-700">Adresse E-mail</label>
                    <input type="email" id="email-register" name="email-register" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- 3. Mot de passe -->
                <div>
                    <label for="password-register" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <div class="relative mt-1">
                        <input type="password" id="password-register" name="password-register" required class="block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 pr-10">
                        <button type="button" id="password-toggle-register" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-800">
                            <i id="password-register-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- 4. Confirmer Mot de passe -->
                <div>
                    <label for="password-confirm" class="block text-sm font-medium text-gray-700">Confirmer le Mot de passe</label>
                    <div class="relative mt-1">
                        <input type="password" id="password-confirm" name="password-confirm" required class="block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 pr-10">
                        <button type="button" id="password-toggle-confirm" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-800">
                            <i id="password-confirm-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 5. Type de Compte (Déplacé en dernier) -->
                <div>
                    <label for="role-select" class="block text-sm font-medium text-gray-700">Type de Compte</label>
                    <select id="role-select" name="role-select" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="Acheteur">Acheteur (Client)</option>
                        <option value="Vendeur">Vendeur (Gère les produits)</option>
                        <option value="Affilié">Affilié (Promoteur)</option>
                        <option value="Admin">Administrateur</option>
                    </select>
                </div>

                
                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl font-semibold hover:bg-blue-700 transition duration-300 shadow-md">
                        Créer mon Compte
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Conteneur de Connexion -->
        <div id="login-form-container" class="hidden">
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email-login" class="block text-sm font-medium text-gray-700">Adresse E-mail</label>
                    <input type="email" id="email-login" name="email-login" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="password-login" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <div class="relative mt-1">
                        <input type="password" id="password-login" name="password-login" required class="block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 pr-10">
                        <button type="button" id="password-toggle-login" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-800">
                            <i id="password-login-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl font-semibold hover:bg-blue-700 transition duration-300 shadow-md">
                        Se Connecter
                    </button>
                </div>
            </form>
        </div>

        <div class="mt-6 text-center">
            <a href="./index.html" class="text-sm text-gray-500 hover:text-blue-600 transition">Retour à l'Accueil</a>
        </div>
    </div>
    
</body>
</html>

