<!-- 
    jeoahs_marketplace.html - La vitrine centrale de la plateforme.
    
    Elle agrège les produits de tous les affiliés/vendeurs abonnés.
    Intègre la taxe de 3% et la logique de redirection NEY.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeoahs Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); // Active les logs de débogage pour Firestore

        const TAX_RATE = 0.03; // Taxe de 3% demandée par l'utilisateur
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db;
        let marketplaceProducts = [];

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('sort-select').addEventListener('change', renderProductList);
        });

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config missing. Running in simulation mode.");
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('marketplace-container').classList.remove('hidden');
                marketplaceProducts = getDemoProducts();
                renderProductList();
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);

            try {
                // Connexion anonyme pour les visiteurs publics
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Erreur d'authentification anonyme:", error);
            }

            startMarketplaceListener();
        }

        /**
         * Simule la collecte et l'agrégation NEY des produits éligibles (vendeurs & affiliés abonnés).
         */
        async function startMarketplaceListener() {
            // Collection publique des produits locaux des Vendeurs
            const vendorProductsCollection = collection(db, `artifacts/${appId}/public/data/vendor_products`);
            // Collection publique des produits affiliés promus par les Affiliés
            const affiliateProductsCollection = collection(db, `artifacts/${appId}/public/data/affiliate_promos`); 
            
            // NOTE: Dans la réalité, NEY chercherait les produits des affiliés *abonnés*
            // et les produits des vendeurs *abonnés* en croisant avec une table 'subscriptions'.
            // Ici, nous simulons la collecte des produits et leur affichage.
            
            // 1. Simuler l'écoute des produits Vendeurs
            onSnapshot(vendorProductsCollection, (snapshot) => {
                let vendorProds = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // On simule l'ajout de la taxe pour l'affichage
                    const priceWithTax = data.price * (1 + TAX_RATE);
                    vendorProds.push({ 
                        id: doc.id, 
                        type: 'vendor', 
                        ...data, 
                        displayPrice: priceWithTax,
                        redirection: `vendor_checkout_page.html?prodId=${doc.id}`, // Dirige vers la page du vendeur
                        affiliateId: data.vendorId // L'ID du vendeur est important
                    });
                });
                // 2. Simuler l'ajout de produits affiliés de démonstration
                marketplaceProducts = [...vendorProds, ...getDemoAffiliateProducts()];
                renderProductList();
            }, (error) => {
                console.error("Erreur onSnapshot produits vendeurs:", error);
                marketplaceProducts = getDemoProducts(); // Fallback
                renderProductList();
            });
            
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('marketplace-container').classList.remove('hidden');
        }

        /**
         * Données de démo si Firestore est vide ou erreur.
         */
        function getDemoProducts() {
            return [
                // Produit Vendeur Local (Dirige vers la page Vendeur)
                { 
                    id: 'vend-001', 
                    type: 'vendor', 
                    name: 'Sacoche en Cuir Artisanal', 
                    description: 'Fait main par notre vendeur Premium. Qualité exceptionnelle.', 
                    imageUrl: 'https://placehold.co/400x300/4F46E5/ffffff?text=SAC+CUIR', 
                    price: 150.00,
                    displayPrice: 150.00 * (1 + TAX_RATE),
                    vendorId: 'local-vend-1',
                    redirection: `vendor_checkout_page.html?prodId=vend-001`,
                    ranking: 10,
                    reduction: 0
                },
                // Produit Affilié (Dirige vers site externe)
                { 
                    id: 'aff-002', 
                    type: 'affiliate', 
                    name: 'Montre Connectée Tendance', 
                    description: 'Meilleur prix agrégé par NEY : trouvez-la sur Temu ou Amazon.', 
                    imageUrl: 'https://placehold.co/400x300/EC4899/ffffff?text=MONTRE+SMART', 
                    price: 55.00,
                    displayPrice: 55.00 * (1 + TAX_RATE),
                    affiliateId: 'affilie-jane-doe',
                    redirection: 'https://temu.com/best_deal_affiliate_link', // Lien externe avec tag
                    ranking: 5,
                    reduction: 15
                },
            ];
        }

        /**
         * Simule les produits affiliés externes (normalement extraits de la BDD)
         */
        function getDemoAffiliateProducts() {
             return [
                { 
                    id: 'aff-003', 
                    type: 'affiliate', 
                    name: 'Kit de Cuisine Gourmet', 
                    description: 'Les ustensiles les mieux notés sur Amazon.', 
                    imageUrl: 'https://placehold.co/400x300/10B981/ffffff?text=KIT+CUISINE', 
                    price: 75.00,
                    displayPrice: 75.00 * (1 + TAX_RATE),
                    affiliateId: 'affilie-bob',
                    redirection: 'https://amazon.com/kit_cuisine_affiliate_link', 
                    ranking: 8,
                    reduction: 5
                },
             ];
        }

        /**
         * Rend la liste des produits après classement NEY et filtrage.
         */
        function renderProductList() {
            const listContainer = document.getElementById('product-list-container');
            const sortCriteria = document.getElementById('sort-select').value;
            
            let sortedProducts = [...marketplaceProducts];

            // 1. Logique de Classement NEY
            if (sortCriteria === 'ranking') {
                // Classement NEY par pertinence/popularité
                sortedProducts.sort((a, b) => (b.ranking || 0) - (a.ranking || 0)); 
            } else if (sortCriteria === 'price_asc') {
                // Prix croissant (après taxe)
                sortedProducts.sort((a, b) => a.displayPrice - b.displayPrice);
            } else if (sortCriteria === 'reduction') {
                // Réduction (tendances du moment)
                sortedProducts.sort((a, b) => (b.reduction || 0) - (a.reduction || 0));
            }

            if (sortedProducts.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-10 text-gray-500 italic">Aucun produit n\'est actuellement disponible sur la Marketplace.</div>';
                return;
            }

            const html = sortedProducts.map(p => {
                const isVendorProduct = p.type === 'vendor';
                const basePrice = formatCurrency(p.price);
                const finalPrice = formatCurrency(p.displayPrice);
                const sourceType = isVendorProduct ? 'Vendeur Local' : 'Affilié Externe';
                const icon = isVendorProduct ? 'fas fa-shop' : 'fas fa-external-link-alt';

                return `
                    <div class="bg-white p-5 rounded-2xl shadow-lg flex flex-col space-y-3 border-t-8 ${isVendorProduct ? 'border-indigo-600' : 'border-blue-600'} hover:shadow-xl transition">
                        
                        <img src="${p.imageUrl}" 
                            alt="${p.name}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/400x300/9CA3AF/ffffff?text=Image+Produit';" 
                            class="w-full h-40 object-cover rounded-lg">
                        
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${p.name}</h3>
                            ${p.reduction > 0 ? `<span class="text-xs font-bold text-red-600 bg-red-100 py-1 px-3 rounded-full">${p.reduction}% OFF</span>` : ''}
                        </div>

                        <p class="text-gray-500 text-sm h-10 overflow-hidden">${p.description}</p>
                        
                        <!-- Prix et Taxe -->
                        <div class="pt-3 border-t border-gray-100">
                            <p class="text-sm text-gray-500">Prix de base: ${basePrice}</p>
                            <p class="text-xs text-green-600 font-semibold mb-2">+ ${TAX_RATE * 100}% Frais de Plateforme (Inclus)</p>
                            
                            <div class="flex items-end justify-between">
                                <p class="text-xl font-extrabold text-gray-800">Prix Final:</p>
                                <p class="text-3xl font-extrabold text-blue-600">${finalPrice}</p>
                            </div>
                        </div>

                        <!-- Redirection NEY -->
                        <div class="pt-3">
                            <button onclick="handleRedirect('${p.redirection}', ${isVendorProduct}, '${p.id}', '${p.affiliateId || p.vendorId}')"
                                    class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center">
                                <i class="${icon} mr-2"></i> ${isVendorProduct ? 'Acheter sur Jeoah\'s' : 'Voir le Meilleur Deal'}
                            </button>
                            <p class="text-xs text-center mt-2 text-gray-500">
                                Source : ${sourceType} (ID: ${p.affiliateId || p.vendorId})
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            listContainer.innerHTML = html;
        }

        /**
         * Gère la redirection selon la source du produit (Vendeur ou Affilié).
         */
        window.handleRedirect = function(url, isVendor, productId, sourceId) {
            console.log(`REDIRECTION NEY: Type=${isVendor ? 'Vendeur' : 'Affilié'} | ID=${sourceId} | Produit=${productId}`);
            
            // NEY: Orientations d'Achat (Ex: si Vendeur A a un stock bas, NEY pourrait rediriger vers le lien affilié Amazon)
            // Pour l'instant, on respecte la logique de base demandée:
            
            if (isVendor) {
                // Redirection vers la page de paiement locale (Vendeur)
                showCustomModal("Achat Vendeur Local", `Redirection vers la page de paiement pour le produit #${productId} du Vendeur ID ${sourceId}.`);
                // window.location.href = url; // Remplacer par la vraie redirection
            } else {
                // Redirection vers le site externe (Affilié) avec le tag inclus
                showCustomModal("Achat Affilié Externe", `Redirection vers le site partenaire pour le produit #${productId}. La commission est tracée pour l'Affilié ID ${sourceId}.`);
                // window.open(url, '_blank'); // Remplacer par la vraie redirection
            }
        }
        
        // Fonction utilitaire de formatage
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        // Modale d'alerte personnalisée (comme dans les autres fichiers)
        window.showCustomModal = function(title, message) {
            const modalId = 'custom-alert-modal';
            document.getElementById(modalId)?.remove();

            const modalHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[999]">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold ${title.includes('Erreur') ? 'text-red-600' : 'text-blue-600'} mb-4">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('${modalId}').remove()" 
                                class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .marketplace-header {
            background: linear-gradient(135deg, #FF6F00 0%, #FF9800 100%); /* Orange vif pour Jeoah's */
            color: white;
            padding: 3rem 1rem;
            box-shadow: 0 5px 20px rgba(255, 111, 0, 0.4);
        }
    </style>
</head>
<body>

    <!-- Overlay de Chargement -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-600"></div>
        <p class="ml-4 text-gray-600 text-lg">Lancement de NEY et chargement de la Vitrine...</p>
    </div>

    <!-- Contenu de la Vitrine Principale -->
    <div id="marketplace-container" class="hidden min-h-screen">
        
        <!-- Entête et Marque -->
        <header class="marketplace-header">
            <div class="max-w-6xl mx-auto text-center">
                <i class="fas fa-gem text-5xl mb-2"></i>
                <h1 class="text-4xl font-extrabold tracking-wider">JEOAH'S MARKETPLACE</h1>
                <p class="text-lg font-medium opacity-90 mt-2">Propulsé par NEY : L'Intelligence de l'Achat Agrégé.</p>
            </div>
        </header>

        <!-- Filtres et Classement -->
        <main class="p-4 sm:p-8">
            <div class="max-w-6xl mx-auto space-y-8">
                
                <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-3 sm:mb-0">
                        <i class="fas fa-list-alt text-orange-500 mr-3"></i> Produits en Vedette
                    </h2>
                    
                    <div class="flex items-center space-x-3 w-full sm:w-auto">
                        <label for="sort-select" class="text-sm font-medium text-gray-700">Classer par NEY :</label>
                        <select id="sort-select" class="py-2 px-4 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="ranking">Meilleur Classement (Tendance)</option>
                            <option value="reduction">Plus Grandes Réductions</option>
                            <option value="price_asc">Prix le plus bas</option>
                        </select>
                    </div>
                </div>

                <!-- Liste des Produits -->
                <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Les cartes produits seront rendues ici par JavaScript -->
                </div>
                
            </div>
        </main>

        <footer class="text-center py-6 text-gray-500 text-sm">
            © 2024 JEOAH'S. Tous droits réservés. | Taxe de 3% appliquée pour frais de service.
        </footer>
    </div>

</body>
</html>

