
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - JEOAH'S</title>

    <!-- META SEO & OPEN GRAPH -->
    <meta name="robots" content="noindex, nofollow"> 

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Config & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="icon" href="/assets/logo.png" type="image/png">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .widget { background-color: white; border-radius: 1rem; box-shadow: 0 4px_6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 2rem; }
        .widget-title { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        #seller-dashboard, #affiliate-dashboard, #admin-dashboard, #become-seller-widget { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center text-2xl font-extrabold text-gray-900">
                <img src="/assets/logo.png" alt="JEOAH'S Logo" class="h-8 mr-3">
                <span data-translate="dashboard_title"></span>
            </a>
            <div>
                <span id="user-greeting" class="text-gray-700 font-semibold"></span>
                <a href="/payment.html" class="ml-4 text-sm font-semibold text-purple-600 hover:text-purple-800"><i class="fas fa-credit-card mr-1"></i> <span data-translate="dashboard_billing_link"></span></a>
                <button id="logout-btn" class="ml-6 text-sm font-semibold text-red-600 hover:text-red-800"><span data-translate="dashboard_logout_button"></span> <i class="fas fa-sign-out-alt ml-1"></i></button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 flex-grow">
        <div id="loader" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i>
            <p class="mt-4 text-gray-600" data-translate="dashboard_loader_text"></p>
        </div>

        <div id="dashboard-content" class="hidden">
            
            <!-- ADMIN DASHBOARD -->
            <div id="admin-dashboard">
                <div class="widget bg-gray-800 text-white">
                    <h2 class="widget-title text-purple-400"><i class="fas fa-user-shield mr-2"></i> Panneau Administrateur</h2>
                    <div id="admin-content" class="mt-4"></div>
                </div>
            </div>

            <!-- VENDOR/SELLER DASHBOARD -->
            <div id="seller-dashboard">
                <div class="widget">
                    <h2 class="widget-title mb-4"><i class="fas fa-store mr-2"></i> <span data-translate="dashboard_seller_title"></span></h2>
                    <div id="seller-content"></div>
                </div>
            </div>

            <!-- AFFILIATE DASHBOARD -->
            <div id="affiliate-dashboard">
                <div class="widget">
                    <h2 class="widget-title mb-4"><i class="fas fa-link mr-2"></i> <span data-translate="dashboard_affiliate_title"></span></h2>
                    <div id="affiliate-content" class="space-y-3"></div>
                </div>
            </div>

            <!-- BECOME A SELLER WIDGET -->
            <div id="become-seller-widget">
                <div class="widget text-center">
                    <h2 class="widget-title mb-2">Rejoignez notre Marketplace</h2>
                    <p class="text-gray-600 mb-4">Commencez à vendre vos propres produits sur JEOAH'S.</p>
                    <a href="/onboarding_social.html?role=vendeur" class="inline-block bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition">
                        Devenir Vendeur
                    </a>
                </div>
            </div>

        </div>
    </main>

    <!-- DIV pour le footer -->
    <div id="footer-container"></div>

    <!-- DIV pour le widget Ney -->
    <div id="ney-widget-container"></div>

    <script src="/assets/js/translator.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAt0NRbbszX8MSikgsYJngdmWzdfYLoBB0",
        authDomain: "jeoahs1-max-03326376-49b27.firebaseapp.com",
        projectId: "jeoahs1-max-03326376-49b27",
        storageBucket: "jeoahs1-max-03326376-49b27.firebasestorage.app",
        messagingSenderId: "893693678979",
        appId: "1:893693678979:web:3243772acee2fde171d2b6"
      };

      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      document.addEventListener('DOMContentLoaded', () => {

          fetch('/footer.html').then(res => res.text()).then(data => document.getElementById('footer-container').innerHTML = data);
          fetch('/ney-widget.html').then(res => res.text()).then(data => {
              document.getElementById('ney-widget-container').innerHTML = data;
              const scriptEl = document.querySelector('#ney-widget-container script');
              if (scriptEl) {
                  const newScript = document.createElement('script');
                  newScript.innerHTML = scriptEl.innerHTML;
                  document.body.appendChild(newScript);
              }
          });

          const loader = document.getElementById('loader');
          const dashboardContent = document.getElementById('dashboard-content');
          const userGreeting = document.getElementById('user-greeting');
          const logoutBtn = document.getElementById('logout-btn');

          auth.onAuthStateChanged(async (user) => {
              if (user) {
                  const userDocRef = db.collection("users").doc(user.uid);
                  const userDoc = await userDocRef.get();

                  if (userDoc.exists()) {
                      const userData = userDoc.data();
                      userGreeting.textContent = `${getTranslation('dashboard_greeting')}, ${userData.fullname ? userData.fullname.split(' ')[0] : 'Utilisateur'} !`;
                      
                      const userRoles = new Set();
                      if (Array.isArray(userData.roles)) {
                          userData.roles.forEach(role => userRoles.add(role));
                      }
                      if (typeof userData.role === 'string') {
                          userRoles.add(userData.role);
                      }

                      // Show dashboards based on roles
                      if (userRoles.has('admin')) {
                          setupAdminDashboard(user.uid, userData);
                      }
                      if (userRoles.has('vendeur')) {
                          setupSellerDashboard(user.uid, userData);
                      } else {
                          // If not a seller, show the widget to become one
                          document.getElementById('become-seller-widget').style.display = 'block';
                      }
                      if (userRoles.has('affilie')) {
                          setupAffiliateDashboard(user.uid, userData);
                      }

                      loader.style.display = 'none';
                      dashboardContent.classList.remove('hidden');

                  } else {
                      console.error("User data not found in Firestore.");
                      window.location.href = 'auth.html';
                  }
              } else {
                  window.location.href = 'auth.html';
              }
          });

          function setupAdminDashboard(userId, userData) {
              const adminDashboard = document.getElementById('admin-dashboard');
              const adminContent = document.getElementById('admin-content');
              adminContent.innerHTML = `<p>Bienvenue, Administrateur. Vous avez les pleins pouvoirs.</p>`;
              adminDashboard.style.display = 'block';
          }

          function setupSellerDashboard(userId, userData) {
              const sellerDashboard = document.getElementById('seller-dashboard');
              const sellerContent = document.getElementById('seller-content');
              sellerContent.innerHTML = `<a href="/add_product.html" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Ajouter un nouveau produit</a>`;
              sellerDashboard.style.display = 'block';
          }

          function setupAffiliateDashboard(userId, userData) {
              const affiliateDashboard = document.getElementById('affiliate-dashboard');
              const affiliateContent = document.getElementById('affiliate-content');
              const links = userData.affiliateInfo?.externalLinks || [];
              
              let content = '';
              if (links.length > 0) {
                  content = '<ul>' + links.map(link => `<li class="truncate"><i class="fas fa-link text-gray-400 mr-2"></i><a href="${link}" target="_blank" class="text-blue-600 hover:underline">${link}</a></li>`).join('') + '</ul>';
              } else {
                  content = '<p class="text-gray-500">Aucun lien d\'affilié externe configuré.</p><a href="/onboarding_affiliate_external_links.html" class="text-purple-600 hover:underline">Commencez par ajouter vos liens</a>';
              }
              affiliateContent.innerHTML = content;
              affiliateDashboard.style.display = 'block';
          }

          logoutBtn.addEventListener('click', () => {
              auth.signOut().then(() => {
                  window.location.href = 'index.html';
              });
          });
      });
    </script>
</body>
</html>
