<div id=\"ney-widget\" class=\"fixed bottom-5 right-5 z-50\">\n    <div id=\"ney-chat-window\" class=\"hidden w-80 sm:w-96 h-[60vh] bg-white rounded-2xl shadow-xl mb-2 flex flex-col\">\n        <div class=\"p-4 bg-purple-600 text-white font-bold rounded-t-2xl flex justify-between items-center cursor-pointer\" id=\"ney-chat-header\">\n            <span>Discutez avec Ney, votre assistant</span>\n            <button id=\"ney-close-btn\" class=\"text-white text-2xl hover:text-gray-200\">&times;</button>\n        </div>\n        <div id=\"ney-chat-body\" class=\"flex-grow p-4 overflow-y-auto bg-gray-50\">\n            <!-- Les messages du chat apparaîtront ici -->\n        </div>\n        <div class=\"p-4 border-t flex items-center\">\n            <input type=\"text\" id=\"ney-chat-input\" placeholder=\"Posez votre question...\" class=\"w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500\">\n            <button id=\"ney-send-btn\" class=\"ml-3 bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-purple-700 transition\"><i class=\"fas fa-paper-plane\"></i></button>\n        </div>\n    </div>\n    <button id=\"ney-toggle-btn\" class=\"bg-purple-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-purple-700 transition\"><i class=\"fas fa-comments text-2xl\"></i></button>\n</div>\n\n<script type=\"module\">\n    import { getAuth } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js\";\n    const auth = getAuth();\n\n    const toggleBtn = document.getElementById(\'ney-toggle-btn\');\n    const closeBtn = document.getElementById(\'ney-close-btn\');\n    const sendBtn = document.getElementById(\'ney-send-btn\');\n    const chatWindow = document.getElementById(\'ney-chat-window\');\n    const chatInput = document.getElementById(\'ney-chat-input\');\n    const chatBody = document.getElementById(\'ney-chat-body\');\n\n    const toggleChat = (visible) => {\n        chatWindow.classList.toggle(\'hidden\', !visible);\n        toggleBtn.classList.toggle(\'hidden\', visible);\n    };\n\n    toggleBtn.addEventListener(\'click\', () => toggleChat(true));\n    closeBtn.addEventListener(\'click\', () => toggleChat(false));\n    document.getElementById(\'ney-chat-header\').addEventListener(\'click\', (e) => { if (e.target.id === \'ney-chat-header\') toggleChat(false); });\n\n    const addMessage = (text, sender) => {\n        const messageDiv = document.createElement(\'div\');\n        messageDiv.className = `my-2 p-3 rounded-lg max-w-xs ${sender === \'user\' ? \'bg-purple-500 text-white self-end ml-auto\' : \'bg-gray-200 text-gray-800 self-start\'}`+\" animate-fade-in\";\n        messageDiv.textContent = text;\n        chatBody.appendChild(messageDiv);\n        chatBody.scrollTop = chatBody.scrollHeight;\n    };\n    \n    const handleSendMessage = async () => {\n        const prompt = chatInput.value.trim();\n        if (!prompt) return;\n\n        addMessage(prompt, \'user\');\n        chatInput.value = \'\';\n        sendBtn.disabled = true;\n\n        addMessage(\"Ney est en train d\'écrire...\", \'ney\');\n\n        try {\n            const user = auth.currentUser;\n            const response = await fetch(\'/api/ney-proxy\', {\n                method: \'POST\',\n                headers: { \'Content-Type\': \'application/json\' },\n                body: JSON.stringify({ prompt: prompt, uid: user ? user.uid : null })\n            });\n\n            const data = await response.json();\n            const neyMessages = chatBody.querySelectorAll(\'.bg-gray-200\');\n            neyMessages[neyMessages.length - 1].textContent = data.reply || \"Désolé, je n\'ai pas pu obtenir de réponse.\";\n\n        } catch (error) {\n            console.error(\"Error contacting Ney proxy:\", error);\n            const neyMessages = chatBody.querySelectorAll(\'.bg-gray-200\');\n            neyMessages[neyMessages.length - 1].textContent = \"Erreur de connexion avec l\'assistant.\";\n        } finally {\n            sendBtn.disabled = false;\n        }\n    };\n\n    sendBtn.addEventListener(\'click\', handleSendMessage);\n    chatInput.addEventListener(\'keypress\', (e) => { if (e.key === \'Enter\') handleSendMessage(); });\n\n    // Add a subtle fade-in animation for messages\n    const style = document.createElement(\'style\');\n    style.textContent = `\n        @keyframes fade-in {\n            from { opacity: 0; transform: translateY(10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n        .animate-fade-in { animation: fade-in 0.3s ease-out; }\n    `;\n    document.head.appendChild(style);\n\n</script>\n