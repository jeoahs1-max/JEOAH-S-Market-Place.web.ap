<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Intégration Affilié - JEOAH\'S</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css\" />\n    <link rel=\"icon\" href=\"/assets/logo.png\" type=\"image/png\">\n    <style> body { font-family: \'Inter\', sans-serif; } </style>\n</head>\n<body class=\"bg-gray-100 flex items-center justify-center min-h-screen\" data-config=\"__FIREBASE_CONFIG__\">\n\n    <main class=\"w-full max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md\">\n        <div class=\"text-center mb-8\">\n            <h1 class=\"text-3xl font-extrabold text-gray-900\">Liens d\'Affiliation</h1>\n            <p class=\"mt-2 text-gray-600\">Saisissez les liens externes pour la promotion de vos produits ou services.</p>\n        </div>\n\n        <form id=\"links-form\" class=\"space-y-6\">\n            <div id=\"links-container\" class=\"space-y-4\"></div>\n            <div class=\"flex justify-between items-center\">\n                <button type=\"button\" id=\"add-link-btn\" class=\"text-purple-600 font-semibold hover:text-purple-800\"><i class=\"fas fa-plus-circle mr-2\"></i>Ajouter un lien</button>\n                <span id=\"link-counter\" class=\"text-sm text-gray-500\">0/10</span>\n            </div>\n            <div id=\"error-message\" class=\"hidden text-red-500 text-sm text-center\"></div>\n            <div class=\"flex justify-end pt-4\">\n                <button type=\"submit\" id=\"submit-btn\" class=\"px-6 py-2 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500\">\n                    Étape suivante <i id=\"submit-spinner\" class=\"fas fa-spinner fa-spin ml-2 hidden\"></i>\n                </button>\n            </div>\n        </form>\n    </main>\n\n    <div id=\"ney-widget-container\"></div>\n\n    <script type=\"module\">\n        import { initializeApp } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js\";\n        import { getAuth, onAuthStateChanged } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js\";\n        import { getFirestore, doc, setDoc } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js\";\n\n        let firebaseConfig = {};\n        try { firebaseConfig = JSON.parse(atob(document.body.dataset.config)); } catch (e) { console.error(\"Invalid Firebase Config\"); }\n\n        const app = initializeApp(firebaseConfig);\n        const auth = getAuth(app);\n        const db = getFirestore(app);\n\n        document.addEventListener(\'DOMContentLoaded\', () => {\n            const linksContainer = document.getElementById(\'links-container\');\n            const addLinkBtn = document.getElementById(\'add-link-btn\');\n            const linkCounter = document.getElementById(\'link-counter\');\n            const form = document.getElementById(\'links-form\');\n            const submitBtn = document.getElementById(\'submit-btn\');\n            const MAX_LINKS = 10;\n\n            const updateCounter = () => {\n                const currentLinks = linksContainer.querySelectorAll(\'input[type=\"url\"]\').length;\n                linkCounter.textContent = `${currentLinks}/${MAX_LINKS}`;
                addLinkBtn.style.display = currentLinks >= MAX_LINKS ? \'none\' : \'inline-block\';\n            };\n\n            const addLinkField = (isFirst = false) => {\n                if (linksContainer.querySelectorAll(\'input[type=\"url\"]\').length >= MAX_LINKS) return;\n                const newField = document.createElement(\'div\');\n                newField.className = \'flex items-center space-x-2\';\n                newField.innerHTML = `\n                    <input type=\"url\" class=\"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500\" placeholder=\"https://...\" ${isFirst ? \'required\' : \'\'} />\n                    <button type=\"button\" class=\"remove-link-btn text-gray-500 hover:text-red-500\">&times;</button>\n                `;\n                linksContainer.appendChild(newField);\n                updateCounter();\n                newField.querySelector(\'.remove-link-btn\').addEventListener(\'click\', () => { newField.remove(); updateCounter(); });\n            };\n            \n            addLinkBtn.addEventListener(\'click\', () => addLinkField());\n            addLinkField(true); // Add initial field\n\n            form.addEventListener(\'submit\', async (e) => {\n                e.preventDefault();\n                const user = auth.currentUser;\n                if (!user) { window.location.href = \'/register.html\'; return; }\n\n                submitBtn.disabled = true;\n                document.getElementById(\'submit-spinner\').classList.remove(\'hidden\');\n\n                const links = Array.from(linksContainer.querySelectorAll(\'input[type=\"url\"]\')).map(input => input.value.trim()).filter(Boolean);\n\n                try {\n                    await setDoc(doc(db, \'users\', user.uid), { affiliateInfo: { externalLinks: links } }, { merge: true });\n                    // CORRECTION: Redirection vers la page des réseaux sociaux\n                    window.location.href = \'/onboarding_social.html\';\n                } catch (error) {\n                    console.error(\"Error saving links:\", error);\n                    document.getElementById(\'error-message\').textContent = \"Une erreur s\'est produite. Veuillez réessayer.\";\n                    document.getElementById(\'error-message\').classList.remove(\'hidden\');\n                    submitBtn.disabled = false;\n                    document.getElementById(\'submit-spinner\').classList.add(\'hidden\');\n                }\n            });\n\n            onAuthStateChanged(auth, (user) => {\n                if (!user) { window.location.href = \'/register.html\'; }\n                // Load Ney widget\n                fetch(\'/ney-widget.html\').then(res => res.text()).then(data => {\n                    document.getElementById(\'ney-widget-container\').innerHTML = data;\n                    const scriptEl = document.querySelector(\'#ney-widget-container script\');\n                    if (scriptEl) {\n                        const newScript = document.createElement(\'script\');\n                        newScript.innerHTML = scriptEl.innerHTML;\n                        document.body.appendChild(newScript);\n                    }\n                });\n            });\n        });\n    </script>\n\n</body>\n</html>\n