<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Configuration des Réseaux Sociaux - JEOAH\'S</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css\" />\n    <style> body { font-family: \'Inter\', sans-serif; } </style>\n</head>\n<body class=\"bg-gray-100 flex items-center justify-center min-h-screen\" data-config=\"__FIREBASE_CONFIG__\">\n    <div class=\"w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md\">\n        <div class=\"text-center\">\n            <h2 class=\"text-3xl font-bold text-gray-900\">Vos Réseaux Sociaux</h2>\n            <p class=\"mt-2 text-sm text-gray-600\">C\'est la dernière étape ! Ajoutez vos liens pour que vos clients puissent vous suivre.</p>\n        </div>\n        <form id=\"social-links-form\" class=\"mt-8 space-y-6\">\n            <div id=\"links-container\" class=\"space-y-4\"></div>\n            <div class=\"flex justify-between items-center\">\n                <button type=\"button\" id=\"add-link-btn\" class=\"text-sm text-blue-600 hover:underline\"><i class=\"fas fa-plus-circle mr-1\"></i>Ajouter un lien (5 max)</button>\n            </div>\n            <div>\n                <button type=\"submit\" id=\"submit-btn\" class=\"w-full px-4 py-2 text-lg font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500\">\n                    Terminer <i id=\"submit-spinner\" class=\"fas fa-spinner fa-spin ml-2 hidden\"></i>\n                </button>\n            </div>\n        </form>\n    </div>\n\n    <div id=\"ney-widget-container\"></div>\n\n    <script type=\"module\">\n        import { initializeApp } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js\";\n        import { getAuth, onAuthStateChanged } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js\";\n        import { getFirestore, doc, setDoc, getDoc } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js\";\n\n        let firebaseConfig = {};\n        try { firebaseConfig = JSON.parse(atob(document.body.dataset.config)); } catch (e) { console.error(\"Invalid Firebase Config\"); }\n\n        const app = initializeApp(firebaseConfig);\n        const auth = getAuth(app);\n        const db = getFirestore(app);\n\n        const linksContainer = document.getElementById(\'links-container\');\n        const addLinkBtn = document.getElementById(\'add-link-btn\');\n        const form = document.getElementById(\'social-links-form\');\n        const submitBtn = document.getElementById(\'submit-btn\');\n        let linkCount = 0;\n\n        const createLinkInput = () => {\n            if (linkCount >= 5) { addLinkBtn.disabled = true; return; }\n            linkCount++;\n            const div = document.createElement(\'div\');\n            div.classList.add(\'relative\');\n            div.innerHTML = `\n                <input name=\"social_link\" type=\"url\" required class=\"w-full px-4 py-2 text-gray-900 bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500\" placeholder=\"https://exemplesite.com\">\n                <button type=\"button\" class=\"absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-red-500 remove-link-btn\">&times;</button>\n            `;\n            linksContainer.appendChild(div);\n        };\n\n        linksContainer.addEventListener(\'click\', (e) => {\n            if (e.target.classList.contains(\'remove-link-btn\')) {\n                e.target.parentElement.remove();\n                linkCount--;\n                if (linkCount < 5) { addLinkBtn.disabled = false; }\n            }\n        });\n\n        addLinkBtn.addEventListener(\'click\', createLinkInput);\n\n        form.addEventListener(\'submit\', async (e) => {\n            e.preventDefault();\n            const user = auth.currentUser;\n            if (!user) { window.location.href = \'/register.html\'; return; }\n\n            submitBtn.disabled = true;\n            document.getElementById(\'submit-spinner\').classList.remove(\'hidden\');\n\n            const links = Array.from(form.querySelectorAll(\'input[name=\"social_link\"]\')).map(input => input.value.trim()).filter(Boolean);\n            const userRef = doc(db, \"users\", user.uid);\n\n            try {\n                const userSnap = await getDoc(userRef);\n                const userData = userSnap.data();\n                \n                // CORRECTION CRITIQUE: On ne modifie plus le rôle, on le préserve.\n                await setDoc(userRef, { socialLinks: links, isSetupComplete: true }, { merge: true });\n\n                // CORRECTION: Redirection basée sur le rôle.\n                if (userData.role === \'acheteur\') {\n                    window.location.href = \'/index.html\';\n                } else {\n                    window.location.href = \'/dashboard.html\';\n                }\n            } catch (error) {\n                console.error(\"Erreur lors de la mise à jour du profil :\", error);\n                alert(\"Une erreur s\'est produite. Veuillez réessayer.\");\n                submitBtn.disabled = false;\n                document.getElementById(\'submit-spinner\').classList.add(\'hidden\');\n            }\n        });\n\n        onAuthStateChanged(auth, async (user) => {\n            if (user) {\n                createLinkInput(); // Add first field\n                // Load Ney widget\n                fetch(\'/ney-widget.html\').then(res => res.text()).then(data => {\n                    document.getElementById(\'ney-widget-container\').innerHTML = data;\n                    const scriptEl = document.querySelector(\'#ney-widget-container script\');\n                    if (scriptEl) {\n                        const newScript = document.createElement(\'script\');\n                        newScript.innerHTML = scriptEl.innerHTML;\n                        document.body.appendChild(newScript);\n                    }\n                });\n            } else {\n                window.location.href = \'/register.html\';\n            }\n        });\n    </script>\n</body>\n</html>\n