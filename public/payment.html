<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Paiement Sécurisé • JEOAH'S</title>
    <!-- SDK Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <!-- SDK Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        .payment-container { display: flex; flex-direction: column; gap: 30px; }
        .payment-box { border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
        .payment-box h3 { margin-top: 0; color: #007bff; }
        #payment-element { margin-bottom: 20px; }
        #card-errors { color: red; margin-top: 10px; }
        button { width: 100%; padding: 12px; border: none; background: #007bff; color: #fff; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #a0a0a0; }
        .manual-payment-instructions p { line-height: 1.6; }
    </style>
</head>

<body>

    <h2>Finaliser votre commande</h2>

    <div class="payment-container">
        
        <!-- SECTION 1: PAIEMENT SÉCURISÉ PAR CARTE & PLUS -->
        <div class="payment-box">
            <h3>Paiement sécurisé par Carte (Visa, Mastercard...), Google Pay & Apple Pay</h3>
            <p>Toutes les transactions sont sécurisées et cryptées par notre partenaire Stripe.</p>
            <form id="payment-form">
                <div id="payment-element">
                    <!-- Le formulaire de paiement Stripe sera inséré ici -->
                </div>
                <button id="submit-button" disabled>Payer</button>
                <div id="card-errors" role="alert"></div>
            </form>
        </div>

        <!-- SECTION 2: PAIEMENT MANUEL POUR HAÏTI -->
        <div class="payment-box manual-payment-instructions">
            <h3>Payer avec MonCash ou NatCash (Haïti)</h3>
            <p>
                1. Envoyez le montant total de votre commande au numéro : <strong>+509 XX XX XX XX</strong>.
            </p>
            <p>
                2. Ensuite, envoyez un email à <strong>contact@jeoahs.com</strong> avec :
                <ul>
                    <li>Votre nom complet</li>
                    <li>Le numéro de la transaction</li>
                    <li>Une capture d'écran du reçu (si possible)</li>
                </ul>
            </p>
            <p>
                Votre commande sera validée manuellement dès réception de votre email.
            </p>
        </div>

    </div>

    <script>
        // =================================================================
        // CONFIGURATION REQUISE - À REMPLACER PAR VOS CLÉS
        // =================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Clé publique Stripe (commence par pk_test_... ou pk_live_...)
        const stripePublicKey = 'pk_test_51SYNGF1alLKcRmX5dZ7YcHe4YIFw9td7eGW2A3Q9nx8e8F3nuA9C2JBc6FasWt16WZwPmbzhKAMZWFsRHD5Xn9uO00v2PUvd0G'; 
        // =================================================================
        // INITIALISATION
        // =================================================================
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const functions = firebase.functions();
        const stripe = Stripe(stripePublicKey);

        let elements;

        // =================================================================
        // LOGIQUE DE PAIEMENT STRIPE
        // =================================================================
        
        // Cette fonction s'exécute dès que la page est chargée
        // Elle appelle une fonction backend (Firebase Function) pour créer une intention de paiement
        async function initialize() {
            const submitButton = document.getElementById('submit-button');
            const cardErrors = document.getElementById('card-errors');
            
            submitButton.disabled = true;
            cardErrors.textContent = "Chargement du formulaire de paiement...";

            try {
                // IMPORTANT: Vous devez créer cette fonction dans Firebase Functions
                const createPaymentIntent = functions.httpsCallable('createPaymentIntent');
                
                // Note: Vous devez passer le montant et la devise à votre fonction.
                // Pour l'exemple, on utilise 10.99 EUR.
                const response = await createPaymentIntent({ amount: 1099, currency: 'eur' });
                const clientSecret = response.data.clientSecret;

                if (!clientSecret) {
                    throw new Error("Le client_secret n'a pas pu être récupéré.");
                }

                const appearance = { theme: 'stripe' };
                elements = stripe.elements({ appearance, clientSecret });

                const paymentElement = elements.create("payment");
                paymentElement.mount("#payment-element");

                cardErrors.textContent = ""; // On efface le message de chargement
                submitButton.disabled = false; // On active le bouton

            } catch (error) {
                console.error("Erreur d'initialisation du paiement:", error);
                cardErrors.textContent = "Erreur de chargement du module de paiement. Veuillez contacter le support.";
            }
        }

        // Gère la soumission du formulaire
        async function handleSubmit(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            const cardErrors = document.getElementById('card-errors');

            submitButton.disabled = true;
            cardErrors.textContent = "";

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // URL de redirection après le paiement
                    return_url: window.location.origin + '/commande-confirmee.html',
                },
            });

            if (error) {
                // Cette partie ne s'exécute que si une erreur immédiate se produit
                cardErrors.textContent = error.message;
                submitButton.disabled = false;
            }
        }

        // =================================================================
        // EXÉCUTION
        // =================================================================
        
        // On attend que l'utilisateur soit connecté pour initialiser le paiement
        auth.onAuthStateChanged(user => {
            if (user) {
                initialize(); // Initialise le formulaire Stripe
                document.getElementById('payment-form').addEventListener('submit', handleSubmit);
            } else {
                // Optionnel : rediriger si l'utilisateur n'est pas connecté
                document.getElementById('card-errors').textContent = "Veuillez vous connecter pour procéder au paiement.";
                // window.location.href = '/login.html';
            }
        });

    </script>

</body>
</html>