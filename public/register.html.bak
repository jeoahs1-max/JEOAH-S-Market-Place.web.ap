<!-- \n    register.html - Page d\'Authentification Unifiée\n    MAJ : Logique de redirection des parcours utilisateurs & Accès Admin.\n-->\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Inscription / Connexion - JEOAH\'S</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css\" />\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap\" rel=\"stylesheet\">\n    <style>\n        body { font-family: \'Inter\', sans-serif; background-color: #f7f9fc; }\n        .card { background-color: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }\n        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s; }\n        .btn-primary:hover { background-color: #4338ca; }\n        .tab-active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; }\n        .tab-inactive { border-color: transparent; color: #6b7280; }\n        .loader { border-top-color: #fff; border-right-color: transparent; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }\n        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n        input:focus, select:focus { border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; outline: none; }\n    </style>\n</head>\n<body data-config=\"__FIREBASE_CONFIG__\">\n    <div class=\"min-h-screen flex items-center justify-center p-4\">\n        <div class=\"card w-full max-w-lg p-6 sm:p-10\">\n            <h1 class=\"text-3xl font-extrabold text-gray-900 mb-6 text-center\">JEOAH\'S - Accès</h1>\n            \n            <div class=\"flex border-b mb-6\">\n                <button id=\"tab-register\" data-tab=\"register\" class=\"flex-1 py-3 text-center border-b-2 tab-active\">Inscription</button>\n                <button id=\"tab-login\" data-tab=\"login\" class=\"flex-1 py-3 text-center border-b-2 tab-inactive\">Connexion</button>\n            </div>\n\n            <div id=\"auth-ui\" class=\"space-y-6\">\n\n                <!-- 1. Conteneur d\'INSCRIPTION -->\n                <div id=\"register-container\">\n                    <form id=\"register-form\" class=\"space-y-4\">\n                        <div>\n                            <label for=\"register-name\" class=\"block text-sm font-medium text-gray-700\">Nom Complet *</label>\n                            <input type=\"text\" id=\"register-name\" required class=\"w-full p-3 border border-gray-300 rounded-lg\" placeholder=\"Votre nom et prénom\">\n                        </div>\n                        <div>\n                            <label for=\"register-email\" class=\"block text-sm font-medium text-gray-700\">Email *</label>\n                            <input type=\"email\" id=\"register-email\" required class=\"w-full p-3 border border-gray-300 rounded-lg\" placeholder=\"exemple@domaine.com\">\n                        </div>\n                        <div class=\"relative\">\n                            <label for=\"register-password\" class=\"block text-sm font-medium text-gray-700\">Mot de passe * (min. 6 caractères)</label>\n                            <input type=\"password\" id=\"register-password\" required minlength=\"6\" class=\"w-full p-3 border border-gray-300 rounded-lg pr-10\" placeholder=\"Mot de passe sécurisé\">\n                            <button type=\"button\" class=\"absolute inset-y-0 right-0 top-6 pt-1 flex items-center pr-3\" data-toggle=\"register-password\"><i class=\"fas fa-eye text-gray-500\"></i></button>\n                        </div>\n                        <div class=\"relative\">\n                            <label for=\"register-confirm-password\" class=\"block text-sm font-medium text-gray-700\">Confirmer Mot de passe *</label>\n                            <input type=\"password\" id=\"register-confirm-password\" required minlength=\"6\" class=\"w-full p-3 border border-gray-300 rounded-lg pr-10\" placeholder=\"Confirmer le mot de passe\">\n                             <button type=\"button\" class=\"absolute inset-y-0 right-0 top-6 pt-1 flex items-center pr-3\" data-toggle=\"register-confirm-password\"><i class=\"fas fa-eye text-gray-500\"></i></button>\n                        </div>\n                        <div>\n                            <label for=\"register-role\" class=\"block text-sm font-medium text-gray-700\">Mon rôle principal *</label>\n                            <select id=\"register-role\" required class=\"w-full p-3 border border-gray-300 rounded-lg\">\n                                <option value=\"acheteur\">Acheteur/Autre</option>\n                                <option value=\"vendeur\">Vendeur</option>\n                                <option value=\"affilie\">Affilié</option>\n                            </select>\n                        </div>\n                        <button type=\"submit\" id=\"register-btn\" class=\"w-full btn-primary text-white font-semibold py-3 rounded-lg shadow-md flex items-center justify-center\"><span id=\"register-btn-text\">Créer un Compte</span><div id=\"register-btn-loader\" class=\"loader h-5 w-5 border-2 rounded-full hidden ml-2\"></div></button>\n                    </form>\n\n                    <div class=\"my-6 flex items-center\"><div class=\"flex-grow border-t border-gray-300\"></div><span class=\"mx-4 text-sm text-gray-500\">OU</span><div class=\"flex-grow border-t border-gray-300\"></div></div>\n                    <button id=\"google-signin-btn\" class=\"w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 font-semibold hover:bg-gray-50 transition\"><img src=\"https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg\" alt=\"Google logo\" class=\"w-5 h-5 mr-3\">S\'inscrire avec Google</button>\n                </div>\n\n                <!-- 2. Formulaire de CONNEXION -->\n                <form id=\"login-form\" class=\"space-y-4 hidden\">\n                    <div>\n                        <label for=\"login-email\" class=\"block text-sm font-medium text-gray-700\">Email *</label>\n                        <input type=\"email\" id=\"login-email\" required class=\"w-full p-3 border border-gray-300 rounded-lg\" placeholder=\"Votre email\">\n                    </div>\n                    <div class=\"relative\">\n                        <label for=\"login-password\" class=\"block text-sm font-medium text-gray-700\">Mot de passe *</label>\n                        <input type=\"password\" id=\"login-password\" required class=\"w-full p-3 border border-gray-300 rounded-lg pr-10\" placeholder=\"Votre mot de passe\">\n                        <button type=\"button\" class=\"absolute inset-y-0 right-0 top-6 pt-1 flex items-center pr-3\" data-toggle=\"login-password\"><i class=\"fas fa-eye text-gray-500\"></i></button>\n                    </div>\n                    <button type=\"submit\" id=\"login-btn\" class=\"w-full btn-primary text-white font-semibold py-3 rounded-lg shadow-md flex items-center justify-center\"><span id=\"login-btn-text\">Se Connecter</span><div id=\"login-btn-loader\" class=\"loader h-5 w-5 border-2 rounded-full hidden ml-2\"></div></button>\n                     <p class=\"text-sm text-center pt-2\"><a href=\"#\" id=\"forgot-password-link\" class=\"text-purple-600 hover:underline\">Mot de passe oublié ?</a></p>\n                </form>\n                \n                <!-- Section Après Succès -->\n                <div id=\"success-area\" class=\"hidden text-center p-6 bg-green-50 border border-green-200 rounded-lg space-y-4\">\n                    <h3 class=\"text-xl font-bold text-green-700\">Authentification Réussie!</h3>\n                    <p id=\"success-message\" class=\"text-gray-600\"></p>\n                    <a href=\"#\" id=\"redirect-link\" class=\"w-full inline-block btn-primary text-white font-semibold py-3 rounded-lg shadow-md mt-4\">Continuer</a>\n                </div>\n            </div>\n            <p id=\"message\" class=\"hidden mt-6 p-3 rounded-lg text-sm font-medium text-center\"></p>\n        </div>\n    </div>\n\n    <script type=\"module\">\n        import { initializeApp } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js\";\n        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js\";\n        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js\";\n\n        let firebaseConfig = {};\n        try { firebaseConfig = JSON.parse(atob(document.body.dataset.config)); } catch (e) { console.error(\"Erreur: Configuration Firebase invalide.\"); }\n        const app = initializeApp(firebaseConfig);\n        const db = getFirestore(app);\n        const auth = getAuth(app);\n\n        // --- UI Functions ---\n        const showTab = (tab) => {\n            document.getElementById(\'register-container\').style.display = tab === \'register\' ? \'block\' : \'none\';\n            document.getElementById(\'login-form\').style.display = tab === \'login\' ? \'block\' : \'none\';\n            document.getElementById(\'tab-register\').classList.toggle(\'tab-active\', tab === \'register\');\n            document.getElementById(\'tab-login\').classList.toggle(\'tab-active\', tab === \'login\');\n        };\n        document.getElementById(\'tab-register\').addEventListener(\'click\', () => showTab(\'register\'));\n        document.getElementById(\'tab-login\').addEventListener(\'click\', () => showTab(\'login\'));\n        document.querySelectorAll(\'[data-toggle]\').forEach(b => b.addEventListener(\'click\', () => { const i = document.getElementById(b.dataset.toggle); i.type = i.type === \'password\' ? \'text\' : \'password\'; }));\n        const displayMessage = (text, type = \'error\') => { const el = document.getElementById(\'message\'); el.textContent = text; el.className = `mt-6 p-3 rounded-lg text-sm font-medium text-center ${type === \'success\' ? \'bg-green-100 text-green-700\' : \'bg-red-100 text-red-700\'}`; };\n        const toggleLoading = (btnId, isLoading, text) => { document.getElementById(`${btnId}-text`).textContent = text; document.getElementById(btnId).disabled = isLoading; document.getElementById(`${btnId}-loader`).classList.toggle(\'hidden\', !isLoading); };\n\n        // --- Core Logic ---\n        const showSuccess = (message, redirectUrl) => {\n            document.getElementById(\'auth-ui\').style.display = \'none\';\n            document.getElementById(\'success-area\').style.display = \'block\';\n            document.getElementById(\'success-message\').textContent = message;\n            document.getElementById(\'redirect-link\').href = redirectUrl;\n            setTimeout(() => { window.location.href = redirectUrl; }, 2500);\n        };\n\n        const getRedirectUrlForRole = (role) => {\n            if (role === \'admin\') return \'/admin.html\';\n            if (role === \'affilie\') return \'/onboarding_affiliate_external_links.html\';\n            if (role === \'vendeur\' || role === \'acheteur\') return \'/onboarding_social.html\';\n            return \'/dashboard.html\'; // Fallback\n        };\n\n        const handleSuccessfulRegistration = (user, finalRole) => {\n            const redirectUrl = getRedirectUrlForRole(finalRole);\n            showSuccess(`Compte créé en tant que ${finalRole.toUpperCase()}. Vous allez être redirigé...`, redirectUrl);\n        };\n\n        const handleSuccessfulLogin = async (user) => {\n            const userRef = doc(db, \"users\", user.uid);\n            const userSnap = await getDoc(userRef);\n            if (userSnap.exists()) {\n                const userData = userSnap.data();\n                const redirectUrl = getRedirectUrlForRole(userData.role);\n                showSuccess(\`Connexion réussie. Redirection vers votre espace...\`, redirectUrl);\n            } else {\n                await auth.signOut();\n                displayMessage(\"Profil non trouvé. Veuillez d\'abord vous inscrire.\");\n            }\n        };\n\n        async function saveUserData(uid, name, email, role) {\n             const userRef = doc(db, \"users\", uid);\n             const finalRole = (email.toLowerCase().includes(\'jeoahs\')) ? \'admin\' : role;\n             const userData = { name, email, role: finalRole, isSetupComplete: false, createdAt: serverTimestamp() };\n             if (finalRole === \'admin\') {\n                 userData.hasFreeAccess = true;\n             }\n             await setDoc(userRef, userData, { merge: true });\n             return finalRole;\n        }\n\n        // --- Event Listeners ---\n        document.getElementById(\'register-form\').addEventListener(\'submit\', async (e) => {\n            e.preventDefault();\n            toggleLoading(\'register-btn\', true, \'Création...\');\n            const [name, email, password, confirmPassword, role] = [\'register-name\', \'register-email\', \'register-password\', \'register-confirm-password\', \'register-role\'].map(id => document.getElementById(id).value.trim());\n            if (password !== confirmPassword) { displayMessage(\"Les mots de passe ne correspondent pas.\"); toggleLoading(\'register-btn\', false, \'Créer un Compte\'); return; }\n\n            try {\n                const userCredential = await createUserWithEmailAndPassword(auth, email, password);\n                const finalRole = await saveUserData(userCredential.user.uid, name, email, role);\n                handleSuccessfulRegistration(userCredential.user, finalRole);\n            } catch (error) { displayMessage(error.code === \'auth/email-already-in-use\' ? \"Cet email est déjà utilisé.\" : `Erreur: ${error.message}`); }\n            finally { toggleLoading(\'register-btn\', false, \'Créer un Compte\'); }\n        });\n\n        document.getElementById(\'google-signin-btn\').addEventListener(\'click\', async () => {\n            const role = document.getElementById(\'register-role\').value;\n            try {\n                const userCredential = await signInWithPopup(auth, new GoogleAuthProvider());\n                const { user } = userCredential;\n                const userRef = doc(db, \"users\", user.uid);\n                const userSnap = await getDoc(userRef);\n\n                if (userSnap.exists()) {\n                    await handleSuccessfulLogin(user);\n                } else {\n                    const finalRole = await saveUserData(user.uid, user.displayName, user.email, role);\n                    handleSuccessfulRegistration(user, finalRole);\n                }\n            } catch (error) { displayMessage(`Échec de la connexion Google: ${error.message}`); }\n        });\n\n        document.getElementById(\'login-form\').addEventListener(\'submit\', async (e) => {\n            e.preventDefault();\n            toggleLoading(\'login-btn\', true, \'Connexion...\');\n            const [email, password] = [\'login-email\', \'login-password\'].map(id => document.getElementById(id).value.trim());\n            try {\n                const userCredential = await signInWithEmailAndPassword(auth, email, password);\n                await handleSuccessfulLogin(userCredential.user);\n            } catch (error) { displayMessage(\"Email ou mot de passe incorrect.\"); }\n            finally { toggleLoading(\'login-btn\', false, \'Se Connecter\'); }\n        });\n\n        document.getElementById(\'forgot-password-link\').addEventListener(\'click\', async (e) => {\n            e.preventDefault();\n            const email = document.getElementById(\'login-email\').value.trim();\n            if (!email) { displayMessage(\"Veuillez d\'abord saisir votre email.\"); return; }\n            try {\n                await sendPasswordResetEmail(auth, email);\n                displayMessage(\"Email de réinitialisation envoyé.\", \"success\");\n            } catch (error) { displayMessage(`Erreur: ${error.message}`); }\n        });\n        \n        onAuthStateChanged(auth, user => {\n            if (user && !user.isAnonymous && window.location.pathname.includes(\'register.html\')) {\n                 getDoc(doc(db, \"users\", user.uid)).then(userSnap => {\n                    if(userSnap.exists()) {\n                         const redirectUrl = getRedirectUrlForRole(userSnap.data().role);\n                         window.location.href = redirectUrl;\n                    } \n                });\n            }\n        });\n\n        showTab(\'register\');\n    </script>\n</body>\n</html>\n