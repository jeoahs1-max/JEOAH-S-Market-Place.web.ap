<!-- 
    vendor_onboarding.html - Page d'Onboarding pour Vendeur JEOAH'S
    
    Permet au vendeur de saisir ses 5 liens de réseaux sociaux avant d'accéder à son tableau de bord.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding Vendeur - JEOAH'S</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Variables globales (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId = null;

        // Réseaux sociaux disponibles
        const socialNetworks = [
            { id: 'facebook', name: 'Facebook', icon: 'fab fa-facebook-f', color: 'text-blue-600' },
            { id: 'instagram', name: 'Instagram', icon: 'fab fa-instagram', color: 'text-pink-600' },
            { id: 'tiktok', name: 'TikTok', icon: 'fab fa-tiktok', color: 'text-black' },
            { id: 'youtube', name: 'YouTube', icon: 'fab fa-youtube', color: 'text-red-600' },
            { id: 'twitter', name: 'X / Twitter', icon: 'fab fa-twitter', color: 'text-gray-900' },
            { id: 'linkedin', name: 'LinkedIn', icon: 'fab fa-linkedin-in', color: 'text-blue-700' },
            { id: 'website', name: 'Site Web', icon: 'fas fa-globe', color: 'text-green-600' },
        ];
        
        // Initialisation de Firebase et vérification du rôle
        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('form-container').innerHTML = '<p class="text-red-500">Erreur : Configuration Firebase manquante.</p>';
                return;
            }
            
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erreur lors de l'authentification initiale:", error);
            }

            onAuthStateChanged(auth, async (user) => {
                const formContainer = document.getElementById('form-container');
                if (!user) {
                    // Si déconnecté, redirection vers la page de connexion
                    window.location.href = 'auth.html';
                    return;
                }
                
                userId = user.uid;
                
                // Vérifier le rôle de l'utilisateur
                const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/profile`);
                const profileSnap = await getDoc(profileDocRef);

                if (profileSnap.exists()) {
                    const role = profileSnap.data().role;
                    if (role !== 'Vendeur') {
                        // Si ce n'est pas un vendeur, le renvoyer au tableau de bord général
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Si Vendeur, vérifier l'état de l'onboarding
                    const onboardingDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendor_data/onboarding`);
                    const onboardingSnap = await getDoc(onboardingDocRef);

                    if (onboardingSnap.exists() && onboardingSnap.data().isComplete === true) {
                        // Onboarding déjà fait, le rediriger directement vers le tableau de bord Vendeur
                        window.location.href = 'vendor_dashboard.html';
                        return;
                    }
                    
                    // Si l'onboarding n'est pas fait, afficher le formulaire
                    formContainer.classList.remove('hidden');
                    document.getElementById('loading-indicator').classList.add('hidden');
                    renderSocialInputs(onboardingSnap.data()?.links || {});
                    
                } else {
                    formContainer.innerHTML = '<p class="text-red-500">Profil utilisateur non trouvé. Reconnectez-vous.</p>';
                }
            });
        }
        
        /**
         * Génère les champs d'entrée des réseaux sociaux.
         */
        function renderSocialInputs(existingLinks) {
            const container = document.getElementById('social-links-container');
            container.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const linkId = `link-${i}`;
                const network = socialNetworks[i] || { id: `custom${i}`, name: `Lien Personnalisé ${i+1}`, icon: 'fas fa-link', color: 'text-gray-500' };
                const existingValue = existingLinks[network.id] || '';

                container.innerHTML += `
                    <div class="relative flex items-center border border-gray-300 rounded-xl focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition duration-150">
                        <span class="p-3 bg-gray-50 rounded-l-xl ${network.color} text-lg">
                            <i class="${network.icon}"></i>
                        </span>
                        <input type="url" 
                                id="${network.id}-input" 
                                name="${network.id}" 
                                placeholder="Lien ${network.name} (https://...)" 
                                value="${existingValue}"
                                ${i < 2 ? 'required' : ''} 
                                class="block w-full px-4 py-2 bg-white rounded-r-xl focus:outline-none text-gray-700">
                    </div>
                `;
            }
            // Ajouter le champ de description de la page
            document.getElementById('page-description').value = existingLinks.description || '';
        }

        /**
         * Gère la soumission du formulaire et l'enregistrement dans Firestore.
         */
        window.handleOnboardingSubmit = async function(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enregistrement...';
            
            const links = {};
            // Récupérer les 5 liens
            for (let i = 0; i < 5; i++) {
                const networkId = socialNetworks[i]?.id;
                if (networkId) {
                    const input = document.getElementById(`${networkId}-input`);
                    // N'enregistrer que les liens non vides
                    if (input && input.value.trim()) {
                        links[networkId] = input.value.trim();
                    }
                }
            }
            
            // Récupérer la description de la page
            const description = document.getElementById('page-description').value.trim();
            
            if (Object.keys(links).length < 1) {
                displayMessage("Veuillez fournir au moins un lien de réseau social.", 'error');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Terminer l\'Onboarding';
                return;
            }

            try {
                // Path: /artifacts/{appId}/users/{userId}/vendor_data/onboarding
                const onboardingDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendor_data/onboarding`);
                
                const dataToSave = {
                    isComplete: true, // Marquer l'onboarding comme terminé
                    links: links,
                    description: description, // Description pour la page publique
                    updatedAt: new Date()
                };

                await setDoc(onboardingDocRef, dataToSave, { merge: true }); // Utiliser merge pour ne pas écraser d'autres données futures

                displayMessage("Onboarding terminé avec succès ! Redirection vers votre tableau de bord Vendeur...", 'success');
                
                setTimeout(() => {
                    window.location.href = 'vendor_dashboard.html';
                }, 2000);

            } catch (error) {
                console.error("Erreur lors de l'enregistrement des liens:", error);
                displayMessage(`Erreur: ${error.message}`, 'error');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Terminer l\'Onboarding';
            }
        }
        
        function displayMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'p-3 rounded-xl text-center font-semibold mb-4';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            messageBox.classList.remove('hidden');
        }

        initFirebase();
    </script>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8 flex items-center justify-center">

    <div class="max-w-xl w-full">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900">Bienvenue Vendeur !</h1>
            <p class="text-gray-500 mt-2">Étape essentielle : Configuration de votre Page JEOAH'S Publique.</p>
        </div>
        
        <div id="loading-indicator" class="flex justify-center items-center h-32">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            <p class="ml-4 text-gray-500">Vérification de votre profil...</p>
        </div>

        <div id="message-box" class="hidden"></div>

        <!-- Conteneur du Formulaire (caché au début) -->
        <div id="form-container" class="bg-white rounded-2xl p-6 sm:p-8 shadow-2xl hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-link text-blue-500 mr-2"></i> 5 Liens de Réseaux Sociaux (Min. 1)
            </h2>
            
            <form id="onboarding-form" onsubmit="handleOnboardingSubmit(event)" class="space-y-6">
                
                <div id="social-links-container" class="space-y-4">
                    <!-- Les champs d'entrée seront générés ici par JS -->
                </div>

                <div>
                    <label for="page-description" class="block text-sm font-medium text-gray-700 mb-1">Description de votre Page Publique (Max 250 caractères)</label>
                    <textarea id="page-description" 
                              name="page-description" 
                              rows="3" 
                              maxlength="250"
                              placeholder="Décrivez votre boutique ou votre marque en quelques mots. Exemple : 'Mode éthique et durable pour femmes modernes.'"
                              class="block w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                </div>
                
                <div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold text-lg hover:bg-green-700 transition duration-300 shadow-lg">
                        Terminer l'Onboarding
                    </button>
                </div>
            </form>
        </div>
    </div>
    
</body>
</html>

